name: Frame Package Test (macOS)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: macos-14

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode with Swift 6
        run: sudo xcode-select -s /Applications/Xcode_16.1.app

      - name: Resolve Binary Dependencies
        run: |
          swift package resolve

      - name: Create & boot iOS 18.1 simulator
        id: sim
        shell: bash
        run: |
          set -e
          RUNTIME=$(xcrun simctl list runtimes | awk -F'[()]' '/iOS 18\.1/{print $2; exit}')
          DEVTYPE="com.apple.CoreSimulator.SimDeviceType.iPhone-16-Pro"
          UDID=$(xcrun simctl create "CI iPhone" "$DEVTYPE" "$RUNTIME")
          echo "udid=$UDID" >> "$GITHUB_OUTPUT"
          xcrun simctl boot "$UDID"
          xcrun simctl list devices available
      
      - name: Test on created sim
        run: |
          xcodebuild test \
            -scheme "Frame-iOS" \
            -destination "id=${{ steps.sim.outputs.udid }}"
      
      - name: Cleanup
        if: always()
        run: xcrun simctl delete "${{ steps.sim.outputs.udid }}"
