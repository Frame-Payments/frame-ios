name: Frame Package Test (iOS)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode 16.4
        run: sudo xcode-select -s /Applications/Xcode_16.4.app

      - name: Resolve Swift Package Dependencies
        run: swift package resolve

      - name: Pick and boot an iOS Simulator
        shell: bash
        run: |
          set -euo pipefail

          echo "== Devices (available) =="
          xcrun simctl list devices available

          # Pick the first available iPhone UDID from any iOS runtime section
          UDID="$(
            xcrun simctl list devices available |
            grep -E '^\s*iPhone ' |
            head -n 1 |
            sed -n 's/.*(\([0-9A-F-]\{36\}\)).*/\1/p'
          )"

          # Fallback to any iPad if no iPhone is present
          if [ -z "$UDID" ]; then
            UDID="$(
              xcrun simctl list devices available |
              grep -E '^\s*iPad ' |
              head -n 1 |
              sed -n 's/.*(\([0-9A-F-]\{36\}\)).*/\1/p'
            )"
          fi

          if [ -z "$UDID" ]; then
            echo "âŒ No available iOS simulators found."
            exit 1
          fi

          echo "Using simulator UDID: $UDID"
          xcrun simctl boot "$UDID" || true
          xcrun simctl bootstatus "$UDID" -b

          echo "SIMULATOR_UDID=$UDID" >> "$GITHUB_ENV"

      - name: Run Tests on iOS Simulator
        run: |
          xcodebuild test \
            -project FrameExample-iOS/FrameExample-iOS.xcodeproj \
            -scheme FrameExample-iOS \
            -destination "id=$SIMULATOR_UDID" \
            -sdk iphonesimulator \
            -enableCodeCoverage YES
