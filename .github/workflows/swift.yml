name: Frame Package Test (iOS)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode 16.4
        run: sudo xcode-select -s /Applications/Xcode_16.4.app

      - name: Resolve Swift Package Dependencies
        run: swift package resolve

      - name: Ensure iOS Simulator Exists
        shell: bash
        run: |
          set -euo pipefail

          echo "Available runtimes:"
          xcrun simctl list runtimes

          echo "Available devices:"
          xcrun simctl list devices available

          # Pick newest available iOS runtime
          RUNTIME_ID=$(
            xcrun simctl list runtimes -j | python3 - <<'PY'
          import json,sys
          j=json.load(sys.stdin)
          ios=[r for r in j["runtimes"] if r.get("isAvailable") and "iOS" in r["name"]]
          ios.sort(key=lambda r: r["version"], reverse=True)
          print(ios[0]["identifier"] if ios else "")
          PY
          )

          if [ -z "$RUNTIME_ID" ]; then
            echo "❌ No iOS runtime available"
            exit 1
          fi

          # Look for an existing simulator
          UDID=$(
            xcrun simctl list devices available -j | python3 - <<'PY'
          import json,sys
          j=json.load(sys.stdin)
          for runtime,devices in j["devices"].items():
              if "iOS" not in runtime: continue
              for d in devices:
                  if d.get("isAvailable"):
                      print(d["udid"])
                      sys.exit(0)
          PY
          )

          # Create one if none exist
          if [ -z "$UDID" ]; then
            echo "No simulator found — creating one"
            UDID=$(xcrun simctl create "CI-iPhone" \
              com.apple.CoreSimulator.SimDeviceType.iPhone-15 \
              "$RUNTIME_ID")
          fi

          echo "Using simulator UDID: $UDID"
          xcrun simctl boot "$UDID" || true
          xcrun simctl bootstatus "$UDID" -b

          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV

      - name: Run Tests on iOS Simulator
        run: |
          xcodebuild test \
            -project FrameExample-iOS/FrameExample-iOS.xcodeproj \
            -scheme FrameExample-iOS \
            -destination "id=$SIMULATOR_UDID" \
            -sdk iphonesimulator \
            -enableCodeCoverage YES
