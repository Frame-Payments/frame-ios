name: Frame Package Test (iOS)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode 16.4
        run: sudo xcode-select -s /Applications/Xcode_16.4.app

      - name: Resolve Swift Package Dependencies
        run: swift package resolve

      - name: Ensure iOS Simulator Exists
        shell: bash
        run: |
          set -euo pipefail

          echo "== Runtimes =="
          xcrun simctl list runtimes

          echo "== Devices (available) =="
          xcrun simctl list devices available

          UDID="$(python3 -c 'import json,subprocess
j=json.loads(subprocess.check_output(["xcrun","simctl","list","devices","available","-j"]))
c=[]
for runtime,devices in j.get("devices",{}).items():
    if "iOS" not in runtime: 
        continue
    for d in devices:
        if not d.get("isAvailable"):
            continue
        name=d.get("name","")
        udid=d.get("udid","")
        rank=0 if "iPhone" in name else 1
        c.append((rank,name,udid))
c.sort()
print(c[0][2] if c else "")')"

          if [ -z "$UDID" ]; then
            echo "âŒ No available iOS simulators found."
            exit 1
          fi

          echo "Using simulator UDID: $UDID"
          xcrun simctl boot "$UDID" || true
          xcrun simctl bootstatus "$UDID" -b

          echo "SIMULATOR_UDID=$UDID" >> "$GITHUB_ENV"

      - name: Run Tests on iOS Simulator
        run: |
          xcodebuild test \
            -project FrameExample-iOS/FrameExample-iOS.xcodeproj \
            -scheme FrameExample-iOS \
            -destination "id=$SIMULATOR_UDID" \
            -sdk iphonesimulator \
            -enableCodeCoverage YES
